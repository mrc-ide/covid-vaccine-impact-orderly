---
title: "Creating the Report"
author: "Greg Barnsley"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(here::here(), "docs", "create_report.html")) })
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
```

## Parameter Choices

```{r, echo=TRUE, eval=FALSE}
date <- "2021-12-05"
#countries to exclude
exclude_iso3cs <- "CHN"
```

Here we set up our parameters to run the report. Whilst `date` is the only one we 
set there are more parameters available such as `excess` which we will set in
the code as our report will make use of the excess mortality fits for the main
body of the report. Also note that for some of these tasks `excess` and `date` 
do nothing in the code, this is just to make sure that the file is using the 
relevant fits/simulations etc.

## Get Model Fits

```{r, echo=TRUE, eval=FALSE}
#SET THIS TO THE LOCATION OF YOUR VERSION OF THE GLOBAL_LMIC_REPORTS_ORDERLY:
repo <- "C:\\Users\\gbarnsle\\Documents\\Covid Vaccine Impact\\global-lmic-reports-orderly"
#are the fits present on this system
fits_present <- TRUE
#should we just take them from onedrive
one_drive <- TRUE
#location?
one_drive_loc <- file.path(
  "C:\\Users\\gbarnsle\\OneDrive - Imperial College London\\nimue_model_fits"
)
if(fits_present){
  fetch_fit_id <- orderly::orderly_run("fetch_fits",
                                     parameters = list(
                                       date = date,
                                       excess = TRUE,
                                       repo = repo,
                                       one_drive = one_drive,
                                       one_drive_loc = one_drive_loc
                                     ), echo = FALSE)
  orderly::orderly_commit(fetch_fit_id)
} else {
  #now we make a zip to send to the other system and run there to collect the fits
  dir.create("remote/export", showWarnings = FALSE, recursive = TRUE)
  dir.create("remote/import", showWarnings = FALSE, recursive = TRUE)
  fetch_fit_id <- orderly::orderly_bundle_pack("remote/export", "fetch_fits",
                       parameters = list(
                                       date = date,
                                       excess = TRUE,
                                       repo = repo
                                     ))
  #now move this fit to the correct system and run with 
  #orderly::orderly_bundle_run() and put the output in remote/import
  orderly::orderly_bundle_import(paste0("remote/import/", fetch_fit_id$id, ".zip"))
}
```

This fetches the model fit objects for report. This take all available objects
from the dedicated fitting repo and requires you to have generated your own fits
with that. Alternatively you can use an included set of fits, or generate a zip
file to run on an other system to get the fits.

## Get other data sources

```{r, echo=TRUE, eval=FALSE}
world_map_id <- orderly::orderly_run("world_map", echo = FALSE)
orderly::orderly_commit(world_map_id)

owid_id <- orderly::orderly_run("owid", parameters = list(date = date), echo = FALSE)
orderly::orderly_commit(owid_id)
```

This gets any other data used e.g. Our World in Data. Archive versions of these 
will be provided with the model fits in the interests of reproducbility. All 
other orderly tasks only draw from objects inside the repo.

## Simulate Counterfactuals

```{r, echo=TRUE, eval=FALSE}
run_simulations_id <- orderly::orderly_run("run_simulations",
                                           parameters = list(
                                             date = date,
                                             seed = 100100,
                                             excess = TRUE,
                                             parallel = FALSE
                                           ), echo = FALSE)
orderly::orderly_commit(run_simulations_id)
```

This is one of the slowest parts of the report. As the number of the draws and 
counter-factuals increases the R objects become very large so it is optimised to 
reduce memory usage and not for speed.

## Create interactive world map

```{r, echo=TRUE, eval=FALSE}
interactive_map_id <- orderly::orderly_run("interactive_map",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE
                                           ), echo = FALSE)
orderly::orderly_commit(interactive_map_id)

#copy files across to github pages directory
destination <- file.path(here::here(), "docs")
origin <- file.path(here::here(), "archive", "interactive_map", 
                    interactive_map_id, "web_page")
for(file in list.files(origin)){
  file.copy(file.path(origin, file), file.path(destination, file), overwrite = TRUE)
}
```

This task generates the interactive leaflet map. The one used on the github 
pages for this repository is copied across from the *web_page* sub directory.

## Generate Table for Report

```{r, echo=TRUE, eval=FALSE}
deaths_averted_table_id <- orderly::orderly_run("deaths_averted_table",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             seed = 1001000011,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_table_id)
```

This generates a Rds of a table of the counter factual deaths averted.

## Generate Figures for Report

```{r, echo=TRUE, eval=FALSE}
example_deaths_averted_plots_id <- orderly::orderly_run("example_deaths_averted_plots",
                                           parameters = list(
                                             date = date,
                                             seed = 1000100
                                           ), echo = FALSE)
orderly::orderly_commit(example_deaths_averted_plots_id)


dot_plots_id <- orderly::orderly_run("dot_plots",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(dot_plots_id)

global_deaths_averted_plot_id <- orderly::orderly_run("global_deaths_averted_plot",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             seed = 1000100,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(global_deaths_averted_plot_id)

map_plot_id <- orderly::orderly_run("map_plot",parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(map_plot_id)
```

These tasks all generate *ggplot* objects so that they are easier to modify when
producing the report.

# Outputs

## GAVI CSV File

```{r, echo=TRUE, eval=FALSE}
summary_table_id <- orderly::orderly_run("summary_table",
                                         parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             seed = 1001332,
                                             exclude_iso3cs = exclude_iso3cs
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(summary_table_id)
```

This is also used for the country specific outputs csv file.

## Compile Plots to Images

```{r, echo=TRUE, eval=FALSE}
compile_plots_id <- orderly::orderly_run("compile_plots",
                                         parameters = list(
                                             date = date
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(compile_plots_id)
```

Originally a report this now just puts the plots into pngs. All in one task so
that it is simple to modify dimensions etc.

## Numbers for Report

```{r, echo=TRUE, eval=FALSE}
generate_numbers_id <- orderly::orderly_run("generate_numbers",
                                         parameters = list(
                                             date = date,
                                             seed = 8006646,
                                             exclude_iso3cs = exclude_iso3cs
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(generate_numbers_id)
```

Generate any other values needed

# Supplementry Plots

## Reported data plots

```{r, echo=TRUE, eval=FALSE}
if(fits_present){
  fetch_fit_id <- orderly::orderly_run("fetch_fits",
                                     parameters = list(
                                       date = date,
                                       excess = FALSE,
                                       repo = repo,
                                       one_drive = one_drive,
                                       one_drive_loc = one_drive_loc
                                     ), echo = FALSE)
  orderly::orderly_commit(fetch_fit_id)
} else {
  #now we make a zip to send to the other system and run there to collect the fits
  dir.create("remote/export", showWarnings = FALSE, recursive = TRUE)
  dir.create("remote/import", showWarnings = FALSE, recursive = TRUE)
  fetch_fit_id <- orderly::orderly_bundle_pack("remote/export", "fetch_fits",
                       parameters = list(
                                       date = date,
                                       excess = FALSE,
                                       repo = repo
                                     ))
  #now move this fit to the correct system and run with 
  #orderly::orderly_bundle_run() and put the output in remote/import
  orderly::orderly_bundle_import(paste0("remote/import/", fetch_fit_id$id, ".zip"))
}
```

Load in the fits

```{r, echo=TRUE, eval=FALSE}
run_simulations_id <- orderly::orderly_run("run_simulations",
                                           parameters = list(
                                             date = date,
                                             seed = 100100112,
                                             excess = FALSE,
                                             parallel = FALSE
                                           ), echo = FALSE)
orderly::orderly_commit(run_simulations_id)
```

Generate simulations

```{r, echo=TRUE, eval=FALSE}
deaths_averted_table_id <- orderly::orderly_run("deaths_averted_table",
                                           parameters = list(
                                             date = date,
                                             excess = FALSE,
                                             seed = 100101011,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_table_id)
```

Generate deaths averted table.

```{r, echo=TRUE, eval=FALSE}
summary_table_id <- orderly::orderly_run("summary_table",
                                         parameters = list(
                                             date = date,
                                             excess = FALSE,
                                             seed = 1001332,
                                             exclude_iso3cs = exclude_iso3cs
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(summary_table_id)
```

GAVI table which we'll use for the country specific data.

```{r, echo=TRUE, eval=FALSE}
fitting_plots_id <- orderly::orderly_run("fitting_plots",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(fitting_plots_id)
```

Generates plots of each fit to go into the appendix, utilises the country fits
not the simulation results

```{r, echo=TRUE, eval=FALSE}
delta_toy_example_id <- orderly::orderly_run("delta_toy_example",
                                             parameters = list(seed = 10001),
                                             echo = FALSE)
orderly::orderly_commit(delta_toy_example_id)

delta_toy_example_india_id <- orderly::orderly_run("delta_toy_example_india",
                                             parameters = list(seed = 1012),
                                             echo = FALSE)
orderly::orderly_commit(delta_toy_example_india_id)
```

Produce model fits for some simulated data to explore the relationship between
immune escape and deaths averted.

```{r, echo=TRUE, eval=FALSE}
#a dummy task to get around that orderly tasks can't depend on the same type of
#task twice
reported_data_for_comparison_id <- orderly::orderly_run("reported_data_for_comparison",
                                           parameters = list(
                                             date = date
                                           ))
orderly::orderly_commit(reported_data_for_comparison_id)

compare_excess_reported_id <- orderly::orderly_run("compare_excess_reported",
                                           parameters = list(
                                             date = date,
                                             exclude_iso3cs = exclude_iso3cs,
                                             seed = 991001
                                           ), echo = FALSE)
orderly::orderly_commit(compare_excess_reported_id)
```

Comparison of deaths averted in excess-mortality fitting and reported deaths.

```{r, echo=TRUE, eval=FALSE}
deaths_averted_hospital_id <- orderly::orderly_run("deaths_averted_hospital",
                                           parameters = list(
                                             date = date,
                                             seed = 1000100,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_hospital_id)

deaths_averted_hospital_numbers_id <- orderly::orderly_run("deaths_averted_hospital_numbers",
                                           parameters = list(
                                             date = date,
                                             seed = 160100,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_hospital_numbers_id)
```

A plot looking at deaths averted by reduction in hospital and ICU burden.

```{r, echo=TRUE, eval=FALSE}
compile_plots_si_id <- orderly::orderly_run("compile_plots_si",
                                         parameters = list(
                                             date = date
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(compile_plots_si_id)
```

Compile some of the figures and tables for the SI.

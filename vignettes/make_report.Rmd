---
title: "Creating the Report"
author: "Greg Barnsley"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(here::here(), "docs", "create_report.html")) })
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
```

## R Packages

```{r, echo=TRUE, eval=FALSE}
#MRC-IDE Packages
devtools::install_github(
  "mrc-ide/squire.page",
  ref = "de251c167035808ab10b930168ac98f753e466cd"
) #should install odin, squire and nimue
devtools::install_github(
  "vimc/orderly"
)
#CRAN packages
install.packages("countrycode") #version 1.3.1
install.packages("future") #version 1.23.0
install.packages("dplyr") #version 1.0.7
install.packages("stringr") #version 1.4.0
install.packages("purrr") #version 0.3.4
install.packages("tidyr") #version 1.2.0
install.packages("readr") #version 2.1.2
install.packages("lubridate") #version 1.8.0
install.packages("tibble") #version 3.1.6
install.packages("rlang") #version 1.0.1
install.packages("ggplot2") #version 3.3.5
install.packages("forcats") #version 0.5.1
install.packages("cowplot") #version 1.1.1
install.packages("ggpubr") #version 0.4.0
install.packages("gridExtra") #version 2.3
install.packages("sf") #version 1.0.6
install.packages("qpdf") #version 1.1
```

All packages used in this repository and the versions used to generate the data.
Feel free to skip if you already have these.

## Parameter Choices

```{r, echo=TRUE, eval=FALSE}
date <- "2021-12-05"
#countries to exclude
exclude_iso3cs <- "CHN"
```

Here we set up our parameters to run the report. Whilst `date` is the only one we 
set there are more parameters available such as `excess` which we will set in
the code as our report will make use of the excess mortality fits for the main
body of the report. Also note that for some of these tasks `excess` and `date` 
do nothing in the code, this is just to make sure that the file is using the 
relevant fits/simulations etc.

The orderly files for this repo should already be setup and includes the 
following tasks: two `fetch_fits` one for the reported deaths and one for
the excess mortality-based fits, `world_map` an sp world map, and `owid` the
vaccination data from Our World in Data. All other tasks should only draw from
other tasks in this repository, and so should recreate the same results.

## Simulate Counterfactuals

```{r, echo=TRUE, eval=FALSE}
run_simulations_id <- orderly::orderly_run("run_simulations",
                                           parameters = list(
                                             date = date,
                                             seed = 100100,
                                             excess = TRUE,
                                             parallel = FALSE
                                           ), echo = FALSE)
orderly::orderly_commit(run_simulations_id)
```

This is one of the slowest parts of the report. As the number of the draws and 
counter-factuals increases the R objects become very large so it is optimised to 
reduce memory usage and not for speed.

## Generate Table for Report

```{r, echo=TRUE, eval=FALSE}
deaths_averted_table_id <- orderly::orderly_run("deaths_averted_table",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             seed = 1001000011,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_table_id)
```

This generates a Rds of a table of the counter factual deaths averted.

## Generate Figures for Report

```{r, echo=TRUE, eval=FALSE}
example_deaths_averted_plots_id <- orderly::orderly_run("example_deaths_averted_plots",
                                           parameters = list(
                                             date = date,
                                             seed = 1000100
                                           ), echo = FALSE)
orderly::orderly_commit(example_deaths_averted_plots_id)


dot_plots_id <- orderly::orderly_run("dot_plots",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(dot_plots_id)

global_deaths_averted_plot_id <- orderly::orderly_run("global_deaths_averted_plot",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             seed = 1000100,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(global_deaths_averted_plot_id)

map_plot_id <- orderly::orderly_run("map_plot",parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(map_plot_id)
```

These tasks all generate *ggplot* objects so that they are easier to modify when
producing the report.

# Outputs

## Compile Plots to Images

```{r, echo=TRUE, eval=FALSE}
compile_plots_id <- orderly::orderly_run("compile_plots",
                                         parameters = list(
                                             date = date
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(compile_plots_id)
```

Originally a report this now just puts the plots into pngs. All in one task so
that it is simple to modify dimensions etc. Table 1 in the paper is taken from
compile_plots_si, generated later in this file.

## Numbers for Report

```{r, echo=TRUE, eval=FALSE}
generate_numbers_id <- orderly::orderly_run("generate_numbers",
                                         parameters = list(
                                             date = date,
                                             seed = 8006646,
                                             exclude_iso3cs = exclude_iso3cs
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(generate_numbers_id)
```

Generate any other values needed

# Supplementry Plots

## Reported data plots

```{r, echo=TRUE, eval=FALSE}
run_simulations_id <- orderly::orderly_run("run_simulations",
                                           parameters = list(
                                             date = date,
                                             seed = 100100112,
                                             excess = FALSE,
                                             parallel = FALSE
                                           ), echo = FALSE)
orderly::orderly_commit(run_simulations_id)
```

Generate simulations

```{r, echo=TRUE, eval=FALSE}
deaths_averted_table_id <- orderly::orderly_run("deaths_averted_table",
                                           parameters = list(
                                             date = date,
                                             excess = FALSE,
                                             seed = 100101011,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_table_id)
```

Generate deaths averted table.

```{r, echo=TRUE, eval=FALSE}
fitting_plots_id <- orderly::orderly_run("fitting_plots",
                                           parameters = list(
                                             date = date,
                                             excess = TRUE,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(fitting_plots_id)
```

Generates plots of each fit to go into the appendix, utilises the country fits
not the simulation results

```{r, echo=TRUE, eval=FALSE}
delta_toy_example_id <- orderly::orderly_run("delta_toy_example",
                                             parameters = list(seed = 10001),
                                             echo = FALSE)
orderly::orderly_commit(delta_toy_example_id)

delta_toy_example_india_id <- orderly::orderly_run("delta_toy_example_india",
                                             parameters = list(seed = 1012),
                                             echo = FALSE)
orderly::orderly_commit(delta_toy_example_india_id)
```

Produce model fits for some simulated data to explore the relationship between
immune escape and deaths averted.

```{r, echo=TRUE, eval=FALSE}
#a dummy task to get around that orderly tasks can't depend on the same type of
#task twice
reported_data_for_comparison_id <- orderly::orderly_run("reported_data_for_comparison",
                                           parameters = list(
                                             date = date
                                           ))
orderly::orderly_commit(reported_data_for_comparison_id)

compare_excess_reported_id <- orderly::orderly_run("compare_excess_reported",
                                           parameters = list(
                                             date = date,
                                             exclude_iso3cs = exclude_iso3cs,
                                             seed = 991001
                                           ), echo = FALSE)
orderly::orderly_commit(compare_excess_reported_id)
```

Comparison of deaths averted in excess-mortality fitting and reported deaths.

```{r, echo=TRUE, eval=FALSE}
deaths_averted_hospital_id <- orderly::orderly_run("deaths_averted_hospital",
                                           parameters = list(
                                             date = date,
                                             seed = 1000100,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_hospital_id)

deaths_averted_hospital_numbers_id <- orderly::orderly_run("deaths_averted_hospital_numbers",
                                           parameters = list(
                                             date = date,
                                             seed = 160100,
                                             exclude_iso3cs = exclude_iso3cs
                                           ), echo = FALSE)
orderly::orderly_commit(deaths_averted_hospital_numbers_id)
```

A plot looking at deaths averted by reduction in hospital and ICU burden.

```{r, echo=TRUE, eval=FALSE}
compile_plots_si_id <- orderly::orderly_run("compile_plots_si",
                                         parameters = list(
                                             date = date
                                           ),
                                         echo = FALSE)
orderly::orderly_commit(compile_plots_si_id)
```

Compile some of the figures and tables for the SI. Table 1 is also generated here.
